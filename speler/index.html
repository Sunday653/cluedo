<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Levend Cluedo - Speler App v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #16213e;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-size: 2em;
        }
        
        h1.team-colored {
            background: var(--team-color, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .screen {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .screen.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        
        .btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #2d3561;
            box-shadow: none;
        }
        
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #16213e;
            border-radius: 12px;
            padding: 25px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .card-display {
            background: #0f3460;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .card-display .icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .card-display .name {
            font-size: 1.2em;
            font-weight: 600;
            color: white;
        }
        
        .card-display .type {
            color: #999;
            margin-top: 5px;
        }
        
        .suggestion-box {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .suggestion-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #1a2942;
            border-radius: 6px;
            margin: 8px 0;
        }
        
        .suggestion-item .label {
            color: #999;
            font-size: 0.9em;
        }
        
        .suggestion-item .value {
            color: white;
            font-weight: 600;
            text-align: right;
        }
        
        .suggestion-item .empty {
            color: #666;
            font-style: italic;
        }
        
        .rotation-info {
            background: #2d3561;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #999;
        }
        
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-small {
            padding: 12px;
            font-size: 16px;
            margin: 0;
        }
        
        /* Tabs */
        .tabs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            background: #0f3460;
            border-radius: 12px;
            padding: 5px;
            gap: 5px;
        }
        
        .tabs:first-of-type {
            margin-bottom: 5px;
        }
        
        .tabs.hidden {
            display: none;
        }
        
        .tab {
            padding: 12px 8px;
            background: transparent;
            color: #999;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Checking animation */
        .checking-item {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .checking-item .team-label {
            font-weight: 600;
            color: white;
        }
        
        .checking-item .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checking-dots {
            display: inline-block;
        }
        
        .checking-dots::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .check-result {
            font-weight: 600;
        }
        
        .check-result.has-card {
            color: #4caf50;
        }
        
        .check-result.no-card {
            color: #666;
        }
        
        #qr-reader {
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .info-box {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        
        .info-box p {
            line-height: 1.6;
            color: #e3e3e3;
        }
        
        .team-badge {
            display: inline-block;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .error {
            background: #c62828;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .success {
            background: #2e7d32;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Accusation specific styles */
        .dropdown {
            width: 100%;
            padding: 12px;
            background: #0f3460;
            color: white;
            border: 1px solid #2d3561;
            border-radius: 8px;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .dropdown option {
            background: #0f3460;
            color: white;
        }
        
        /* Penalty frozen screen */
        .penalty-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .penalty-overlay.active {
            display: flex;
        }
        
        .penalty-content {
            background: #16213e;
            border-radius: 12px;
            padding: 40px 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .penalty-content h2 {
            font-size: 2em;
            margin-bottom: 20px;
            color: #ff6b6b;
        }
        
        .penalty-timer {
            font-size: 3em;
            font-weight: bold;
            color: white;
            margin: 20px 0;
            font-family: monospace;
        }
        
        .penalty-message {
            font-size: 1.1em;
            color: #999;
        }
        
        /* Win screen */
        .win-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .win-overlay.active {
            display: flex;
        }
        
        .win-content {
            background: #16213e;
            border-radius: 12px;
            padding: 40px 30px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            position: relative;
            overflow: hidden;
        }
        
        .win-content h2 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #4caf50;
        }
        
        .win-stats {
            font-size: 1.2em;
            margin: 20px 0;
            color: white;
        }
        
        .win-stats div {
            margin: 10px 0;
        }
        
        /* Confetti animation */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f39c12;
            animation: confetti-fall 3s linear infinite;
            z-index: 2001;
        }
        
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        
        .confetti:nth-child(2n) { background: #e74c3c; animation-delay: 0.2s; }
        .confetti:nth-child(3n) { background: #3498db; animation-delay: 0.4s; }
        .confetti:nth-child(4n) { background: #2ecc71; animation-delay: 0.6s; }
        .confetti:nth-child(5n) { background: #9b59b6; animation-delay: 0.8s; }
        
        /* Loading dots animation - 3 cycles */
        .loading-dots {
            display: inline-block;
            width: 30px;
            text-align: left;
            margin-left: 5px;
            vertical-align: baseline;
            line-height: 1;
        }
        
        .loading-dots::after {
            content: '...';
            display: inline-block;
            width: 30px;
            animation: dotsSequential 5s linear infinite;
            letter-spacing: 2px;
        }
        
        @keyframes dotsSequential {
            0%, 5% { content: ''; }
            6%, 11% { content: '.'; }
            12%, 17% { content: '..'; }
            18%, 33% { content: '...'; }
            34%, 39% { content: ''; }
            40%, 45% { content: '.'; }
            46%, 51% { content: '..'; }
            52%, 66% { content: '...'; }
            67%, 72% { content: ''; }
            73%, 78% { content: '.'; }
            79%, 84% { content: '..'; }
            85%, 100% { content: '...'; }
        }
        /* Compact QR scanner - verwijder onnodige ruimte, behoud camera-knop */
        /* Verberg alleen de "Scan an image file" optie (tweede sectie) */
        [id$="__dashboard_section_fileselection"] {
            display: none !important;
        }
        /* Verberg de "Or" tekst tussen de twee opties */
        [id$="__dashboard_section_csr"] + span {
            display: none !important;
        }
        /* Verberg status/info tekst onder camera */
        [id$="__status_span"] {
            display: none !important;
        }
        /* Verberg de "Scan type change" link (wissel naar file) */
        [id$="__dashboard_section_swaplink"] {
            display: none !important;
        }
        /* Geen border/padding op de container zelf */
        #qr-reader, #qr-reader-config, #qr-reader-card,
        #qr-reader-scout, #qr-reader-team-check, #qr-reader-accusation {
            border: none !important;
            padding: 0 !important;
        }
        /* Camera video compact */
        [id$="__scan_region"] {
            padding: 0 !important;
            min-height: unset !important;
        }
        [id$="__scan_region"] video {
            max-width: 100% !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üïµÔ∏è Levend Cluedo</h1>
        
        <!-- Screen 1: Welcome -->
        <div id="screen-welcome" class="screen active">
            <div class="card">
                <h2>Welkom Detective!</h2>
                <div class="info-box">
                    <p><strong>Stap 1:</strong> Scan je Team QR-code<br>
                    <strong>Stap 2:</strong> Scan de Config QR-code<br>
                    <strong>Stap 3:</strong> Start met spelen!</p>
                </div>
                
                <div id="scan-status" style="background: #0f3460; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 1.1em;">
                        <span id="status-icon">‚è≥</span>
                        <span id="status-text">Wachtend op team scan...</span>
                    </div>
                </div>

                <button id="scan-team-btn" class="btn" onclick="startTeamScan()">üî∑ Scan Team QR</button>
                <button id="scan-config-btn" class="btn" onclick="startConfigScan()" disabled style="opacity: 0.5;">üé≤ Scan Config QR</button>
                <button id="reset-btn" class="btn btn-secondary" onclick="resetApp()">üîÑ Reset</button>
            </div>
        </div>
        
        <!-- Screen 2: Team Scan -->
        <div id="screen-team-scan" class="screen">
            <div class="card">
                <h2>Scan Team QR-code</h2>
                <div class="info-box">
                    <p>Scan de QR-code die bij jouw team hoort</p>
                </div>
                <div id="qr-reader"></div>
                <button class="btn btn-secondary" onclick="cancelScan()">Annuleren</button>
            </div>
        </div>
        
        <!-- Screen 3: Config Scan -->
        <div id="screen-config-scan" class="screen">
            <div class="card">
                <h2>Scan Config QR-code</h2>
                <div class="team-badge" id="team-badge"></div>
                <div class="info-box">
                    <p>Nu de spelconfiguratie scannen van de spelleider</p>
                </div>
                <div id="qr-reader-config"></div>
                <button class="btn btn-secondary" onclick="backToWelcome()">Terug</button>
            </div>
        </div>
        
        <!-- Screen 4: Playing (Main Game) -->
        <div id="screen-playing" class="screen">
            <div class="card">
                <!-- Tabs - Row 1 -->
                <div class="tabs" id="tabs-row-1">
                    <button class="tab" onclick="switchGameTab('my-cards-tab')">üÉè Kaarten</button>
                    <button class="tab active" onclick="switchGameTab('suggestion-tab')">üîç Suggestie</button>
                    <button class="tab" onclick="switchGameTab('history-tab')">üìú Logboek</button>
                </div>
                
                <!-- Tabs - Row 2 -->
                <div class="tabs" id="tabs-row-2">
                    <button class="tab" onclick="switchGameTab('accusation-tab')">üë©üèª‚Äç‚öñÔ∏è Beschuldig</button>
                    <button class="tab" onclick="switchGameTab('info-tab')">‚ÑπÔ∏è Info</button>
                    <button class="tab" onclick="switchGameTab('reset-tab')">üîÑ Reset</button>
                </div>
                
                <!-- Scout Tabs (hidden by default) -->
                <div class="tabs hidden" id="tabs-scout">
                    <button class="tab active" onclick="switchGameTab('scout-decoder-tab')">üì° Decoder</button>
                    <button class="tab" onclick="switchGameTab('scout-log-tab')">üìú Logboek</button>
                    <button class="tab" onclick="switchGameTab('reset-tab')">üîÑ Reset</button>
                </div>

                <!-- Tab 1: Mijn Kaarten -->
                <div id="my-cards-tab" class="tab-content">
                    <h2>Jouw Kaarten</h2>
                    <div class="info-box">
                        <div id="my-cards"></div>
                    </div>
                </div>
                
                <!-- Tab 2: Suggestie -->
                <div id="suggestion-tab" class="tab-content active">
                    <div class="suggestion-box" style="margin-bottom: 10px;">
                        <div class="suggestion-item">
                            <div>
                                <div class="label">üë§ Persoon:</div>
                            </div>
                            <div class="value" id="suggestion-person">
                                <span class="empty">Scan kaart</span>
                            </div>
                        </div>
                        <div class="suggestion-item">
                            <div>
                                <div class="label">üî™ Wapen:</div>
                            </div>
                            <div class="value" id="suggestion-weapon">
                                <span class="empty">Scan kaart</span>
                            </div>
                        </div>
                        <div class="suggestion-item">
                            <div>
                                <div class="label">üè† Locatie:</div>
                            </div>
                            <div class="value" id="suggestion-location">
                                <span class="empty">Scan kaart</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn" id="scan-card-btn" onclick="scanCard()">üî∑ Scan Kaart</button>
                    <button class="btn" id="check-suggestion-btn" onclick="checkSuggestion()" disabled>üîç Controleer</button>
                </div>
                
                <!-- Tab 3: Logboek -->
                <div id="history-tab" class="tab-content">
                    <h2>Logboek</h2>
                    <div id="history-list">
                        <div class="info-box">
                            <p style="text-align: center; color: #999;">Nog geen geschiedenis</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tab 4: Beschuldiging -->
                <div id="accusation-tab" class="tab-content">
                    <h2>Beschuldiging</h2>
                    <div class="info-box">
                        <p>‚ö†Ô∏è Let op: Bij een foute beschuldiging krijg je een tijdstraf!</p>
                    </div>
                    <button class="btn" id="scan-accusation-btn" onclick="startAccusationScan()">üëÄ Scan Beschuldigings QR</button>
                </div>
                
                <!-- Tab 5: Informatie -->
                <div id="info-tab" class="tab-content">
                    <h2>Informatie</h2>
                    <div class="rotation-info" id="rotation-info"></div>
                    <div class="info-box" style="margin-top: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">Hoe werkt het spel?</h3>
                        <p style="line-height: 1.6; color: #e3e3e3;">
                            <strong>Suggestie doen:</strong><br>
                            Scan 3 kaarten (persoon, wapen, locatie) en controleer of andere teams deze hebben.<br><br>
                            <strong>Controle volgorde:</strong><br>
                            Teams worden gecontroleerd in de bovenstaande volgorde. Het eerste team met een kaart toont deze.<br><br>
                            <strong>Beschuldiging:</strong><br>
                            Als je denkt dat je de oplossing weet, scan de beschuldigings QR bij de spelleider.
                        </p>
                    </div>
                </div>
                
                <!-- Scout Tab: Decoder -->
                <div id="scout-decoder-tab" class="tab-content">
                    <h2>Decoder</h2>
                    <div class="info-box">
                        <p>Houd de QR-code in beeld totdat de voortgangsbalk vol is.</p>
                    </div>
                    <button class="btn" id="scout-scan-btn" onclick="startScoutScan()">üì∑ Scan QR-code</button>
                </div>

                <!-- Scout Tab: Logboek -->
                <div id="scout-log-tab" class="tab-content">
                    <h2>Logboek</h2>
                    <div id="scout-log-list">
                        <div class="info-box">
                            <p style="text-align:center; color:#999;">Nog niets gedecodeerd</p>
                        </div>
                    </div>
                </div>

                <!-- Tab 6: Reset -->
                <div id="reset-tab" class="tab-content">
                    <h2>Reset App</h2>
                    <div class="info-box">
                        <p style="color: #ff6b6b;">‚ö†Ô∏è <strong>Waarschuwing:</strong><br>
                        Dit verwijdert al je voortgang en geschiedenis. Deze actie kan niet ongedaan worden gemaakt.</p>
                    </div>
                    <button class="btn btn-secondary" onclick="resetApp()" style="background: #dc3545;">üîÑ Reset App</button>
                </div>
            </div>
        </div>
        
        <!-- Scout Scan Modal -->
        <div id="scout-scan-modal" class="modal">
            <div class="modal-content">
                <h3>üì° Decoderen</h3>
                <div id="scout-progress-container" style="background:#0f3460; border-radius:8px; padding:10px; margin-bottom:10px; position:relative;">
                    <div style="background:#1a2942; border-radius:4px; height:24px; overflow:hidden; position:relative;">
                        <div id="scout-progress-bar" style="height:100%; width:0%; background:var(--team-color, linear-gradient(90deg,#667eea,#764ba2)); transition:width 0.1s linear; border-radius:4px;"></div>
                        <span id="scout-progress-pct" style="position:absolute; right:8px; top:50%; transform:translateY(-50%); color:white; font-weight:bold; font-size:0.85em; text-shadow:0 1px 2px rgba(0,0,0,0.5);">0%</span>
                        <div id="scout-alert" class="hidden" style="position:absolute; inset:0; background:rgba(198,40,40,0.92); display:flex; align-items:center; justify-content:center; gap:8px; border-radius:4px; font-size:0.82em; font-weight:bold; color:white; padding:0 8px;">
                            <span>‚ö†Ô∏è</span><span id="scout-recovery-countdown"></span>
                        </div>
                    </div>
                </div>
                <div id="qr-reader-scout"></div>
                <button class="btn btn-secondary" onclick="cancelScoutScan()" style="margin-top:10px;">Annuleren</button>
            </div>
        </div>

        <!-- Scout Card Result Modal -->
        <div id="scout-card-modal" class="modal">
            <div class="modal-content">
                <h3>Gedecodeerde Kaart</h3>
                <div class="card-display">
                    <div class="icon" id="scout-card-icon"></div>
                    <div class="name" id="scout-card-name"></div>
                    <div class="type" id="scout-card-type"></div>
                </div>
                <div class="modal-buttons">
                    <button class="btn btn-small" onclick="addToScoutLog()">‚úÖ Toevoegen aan logboek</button>
                </div>
            </div>
        </div>

        <!-- Card Scan Modal -->
        <div id="card-scan-modal" class="modal">
            <div class="modal-content">
                <h3>Scan Kaart</h3>
                <div id="qr-reader-card"></div>
                <button class="btn btn-secondary" onclick="closeCardScan()">Annuleren</button>
            </div>
        </div>
        
        <!-- Card Confirm Modal -->
        <div id="card-confirm-modal" class="modal">
            <div class="modal-content">
                <h3>Gescande Kaart</h3>
                <div class="card-display">
                    <div class="icon" id="confirm-card-icon"></div>
                    <div class="name" id="confirm-card-name"></div>
                    <div class="type" id="confirm-card-type"></div>
                </div>
                <div id="confirm-message" class="info-box"></div>
                <div class="modal-buttons">
                    <button class="btn btn-secondary btn-small" onclick="closeCardConfirm()">Nee</button>
                    <button class="btn btn-small" onclick="confirmAddCard()">Ja, toevoegen</button>
                </div>
            </div>
        </div>
        
        <!-- Suggestion Result Modal -->
        <div id="suggestion-result-modal" class="modal">
            <div class="modal-content">
                <h3>Suggestie Resultaat</h3>
                <div class="suggestion-box">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div id="result-person"></div>
                        <div id="result-weapon"></div>
                        <div id="result-location"></div>
                    </div>
                </div>
                <div id="result-message"></div>
                <button class="btn" onclick="closeResultModal()">OK</button>
            </div>
        </div>
        
        <!-- Team Check Modal -->
        <div id="team-check-modal" class="modal">
            <div class="modal-content">
                <h3>Team Match Gevonden!</h3>
                <div class="success" style="margin-bottom: 15px;">
                    <span id="team-check-message"></span>
                </div>
                <div id="qr-reader-team-check" class="hidden"></div>
                <button class="btn" id="start-team-scan-btn" onclick="startTeamCheckScan()">üî∑ Scan Team QR</button>
                <button class="btn btn-secondary" onclick="closeTeamCheck()">Annuleren</button>
            </div>
        </div>
        
        <!-- Checking Teams Modal -->
        <div id="checking-modal" class="modal">
            <div class="modal-content">
                <h3>üîç Teams Controleren...</h3>
                <div id="checking-list"></div>
            </div>
        </div>
        
        <!-- Accusation Scan Modal -->
        <div id="accusation-scan-modal" class="modal">
            <div class="modal-content">
                <h3>Scan Beschuldigings QR</h3>
                <div id="qr-reader-accusation"></div>
                <button class="btn btn-secondary" onclick="closeAccusationScan()">Annuleren</button>
            </div>
        </div>
        
        <!-- Accusation Modal -->
        <div id="accusation-modal" class="modal">
            <div class="modal-content">
                <h3>‚öñÔ∏è BESCHULDIGING</h3>
                
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 5px; color: #999;">üë§ Persoon:</label>
                    <select id="accusation-person" class="dropdown" onchange="updateAccusationButton()">
                        <option value="">Kies persoon...</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 5px; margin-top: 15px; color: #999;">üî™ Wapen:</label>
                    <select id="accusation-weapon" class="dropdown" onchange="updateAccusationButton()">
                        <option value="">Kies wapen...</option>
                    </select>
                    
                    <label style="display: block; margin-bottom: 5px; margin-top: 15px; color: #999;">üè† Locatie:</label>
                    <select id="accusation-location" class="dropdown" onchange="updateAccusationButton()">
                        <option value="">Kies locatie...</option>
                    </select>
                </div>
                
                <div class="info-box" style="background: #3d2817; border-left-color: #ffc107; margin: 20px 0;">
                    <p style="color: #ffc107;">‚ö†Ô∏è <strong>Let op!</strong><br>
                    Fout = <span id="penalty-warning"></span> minuten penalty</p>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary btn-small" onclick="closeAccusationModal()">‚ùå Annuleren</button>
                    <button class="btn btn-small" id="confirm-accusation-btn" onclick="showDoubleCheck()" disabled>‚öñÔ∏è Bevestig</button>
                </div>
            </div>
        </div>
        
        <!-- Double Check Modal -->
        <div id="double-check-modal" class="modal">
            <div class="modal-content">
                <h3>ü§î Weet je het ZEKER?</h3>
                
                <div class="info-box" style="margin: 20px 0;">
                    <p><strong>Je beschuldigt:</strong></p>
                    <div id="double-check-summary" style="margin-top: 10px;"></div>
                </div>
                
                <div class="info-box" style="background: #3d2817; border-left-color: #ff6b6b;">
                    <p style="color: #ff6b6b;" id="double-check-penalty-text">‚ùå <strong>Fout = Penalty!</strong></p>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-secondary btn-small" onclick="closeDoubleCheck()">‚ùå Nee, toch niet</button>
                    <button class="btn btn-small" onclick="startEnvelopeOpening()">‚úÖ Ja, ik weet het zeker!</button>
                </div>
            </div>
        </div>
        
        <!-- Envelope Opening Modal -->
        <div id="envelope-modal" class="modal">
            <div class="modal-content" style="text-align: center;">
                <h3 id="envelope-title">De envelop wordt geopend...</h3>
                
                <div id="envelope-animation" style="margin: 30px 0;">
                    <div style="font-size: 4em; margin-bottom: 20px;">‚úâÔ∏è</div>
                    <div style="color: #999; font-size: 1.1em;" id="envelope-status">Even geduld...</div>
                </div>
                
                <div id="envelope-solution" class="hidden" style="margin: 20px 0;">
                    <div id="envelope-summary" style="margin-top: 10px; font-size: 1.1em;"></div>
                </div>
                
                <div id="envelope-result" class="hidden" style="margin-top: 30px; text-align: center;">
                    <!-- Result appears here -->
                </div>
            </div>
        </div>
        
        <!-- Penalty Overlay -->
        <div id="penalty-overlay" class="penalty-overlay">
            <div class="penalty-content">
                <h2>‚ùå ONJUIST!</h2>
                <div class="penalty-timer" id="penalty-timer">00:00</div>
                <div class="penalty-message">
                    Je mag over <span id="penalty-seconds">0</span> sec<br>
                    weer verder spelen
                </div>
            </div>
        </div>
        
        <!-- Penalty End Modal -->
        <div id="penalty-end-modal" class="modal">
            <div class="modal-content">
                <h3>‚ùå Je beschuldiging was onjuist!</h3>
                <div class="info-box" style="margin: 20px 0;">
                    <p style="text-align: center;">
                        Ga je huiswerk doen en kom pas terug als je zeker bent dat je alle feiten gevonden hebt!
                    </p>
                </div>
                <button class="btn" onclick="closePenaltyEnd()">Ok√©, verder spelen</button>
            </div>
        </div>
        
        <!-- Win Overlay -->
        <div id="win-overlay" class="win-overlay">
            <div class="win-content" id="win-content">
                <h2>
                    <span style="display: inline-block;">üéâ</span>
                    GEWONNEN!
                    <span style="display: inline-block; transform: scaleX(-1);">üéâ</span>
                </h2>
                <div class="win-stats">
                    <div>‚è±Ô∏è Tijd: <span id="win-time">00:00</span></div>
                    <div>üìù Suggesties: <span id="win-suggestions">0</span></div>
                </div>
                <button class="btn" id="win-continue-btn" onclick="closeWinScreen()" disabled>
                    Klik hier om door te gaan
                </button>
                <div style="margin-top: 10px; color: #999; font-size: 0.9em;" id="win-timer-text">
                    (knop actief over 5 sec)
                </div>
            </div>
        </div>
        
        <!-- Error message placeholder -->
        <div id="error-message" class="error hidden"></div>
    </div>
    
    <script>
        // Global state
        let gameState = {
            role: null, // 'player' or 'scout'
            teamNumber: null,
            teamName: null,
            teamColor: null,
            config: null,
            myCards: [],
            scoutLog: [],
            currentSuggestion: {
                person: null,
                weapon: null,
                location: null
            },
            history: [],
            scanner: null,
            gameStartTime: null,
            penalty: {
                active: false,
                endTime: null,
                reason: null
            },
            gameWon: {
                won: false,
                timestamp: null,
                timeElapsed: null,
                suggestionsCount: null,
                solution: null
            }
        };
        
        let penaltyInterval = null;
        
        // Check for existing game on load
        window.addEventListener('load', () => {
            // Check for reset parameter
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('reset')) {
                performReset();
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            loadGameState();
            
            // Auto-save on page hide (iOS Safari compatible)
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    saveGameState();
                }
            });
            
            // Also save on beforeunload (Android Chrome)
            window.addEventListener('beforeunload', saveGameState);
        });
        
        // Save game state to localStorage
        function saveGameState() {
            if (!gameState.teamNumber) return;
            const prefix = gameState.role === 'scout' ? 'cluedo_scout_team' : 'cluedo_team';
            const key = `${prefix}${gameState.teamNumber}_state`;
            try {
                localStorage.setItem(key, JSON.stringify(gameState));
                console.log('Game state saved');
            } catch (err) {
                console.error('Failed to save:', err);
                showError('Kon spelstatus niet opslaan. Gebruik geen incognito mode!');
            }
        }
        
        // Load game state from localStorage
        function loadGameState() {
            for (let i = 1; i <= 6; i++) {
                for (const prefix of ['cluedo_team', 'cluedo_scout_team']) {
                    const key = `${prefix}${i}_state`;
                    const saved = localStorage.getItem(key);
                    if (saved) {
                        try {
                            gameState = JSON.parse(saved);
                            console.log('Loaded saved game for team', i, 'role', gameState.role);

                            // Penalty only applies to players
                            if (gameState.role !== 'scout' && gameState.penalty && gameState.penalty.active) {
                                const now = Date.now();
                                if (now < gameState.penalty.endTime) {
                                    showScreen('screen-playing');
                                    displayTeamInfo();
                                    startPenaltyTimer();
                                    return;
                                } else {
                                    showScreen('screen-playing');
                                    displayTeamInfo();
                                    gameState.penalty.active = false;
                                    saveGameState();
                                    document.getElementById('penalty-end-modal').classList.add('active');
                                    return;
                                }
                            }

                            showScreen('screen-playing');
                            if (gameState.role === 'scout') {
                                activateScoutUI();
                            } else {
                                displayTeamInfo();
                                displayMyCards();
                                updateButtonStates();
                            }
                            return;
                        } catch (err) {
                            console.error('Failed to load saved game:', err);
                        }
                    }
                }
            }
        }
        
        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        // Show error
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
        
        // Start Team QR scan
        function startTeamScan() {
            showScreen('screen-team-scan');
            
            gameState.scanner = new Html5QrcodeScanner(
                "qr-reader",
                { 
                    fps: 10,
                    qrbox: { width: 200, height: 200 },
                    aspectRatio: 1.0
                }
            );
            
            gameState.scanner.render(onTeamQRScanned, onScanError);
        }
        
        // Team QR scanned
        function onTeamQRScanned(decodedText) {
            console.log('Team QR scanned:', decodedText);
            
            try {
                const qrData = JSON.parse(decodedText);
                const decompressed = LZString.decompressFromBase64(qrData.data);
                const teamData = JSON.parse(decompressed);
                
                if (teamData.type !== 'team' && teamData.type !== 'scout') {
                    showError('Dit is geen Team of Verkenner QR-code!');
                    return;
                }

                gameState.role = teamData.type === 'scout' ? 'scout' : 'player';
                gameState.teamNumber = teamData.teamNumber;
                gameState.teamName = teamData.teamName;
                gameState.teamColor = teamData.teamColor;
                
                gameState.scanner.clear();
                gameState.scanner = null;
                
                const roleLabel = gameState.role === 'scout' ? 'Verkenner' : 'Team';
                showScreen('screen-welcome');
                document.getElementById('status-icon').textContent = '‚úÖ';
                document.getElementById('status-text').innerHTML = `<strong>${roleLabel} gescand!</strong> ${teamData.teamName} (${teamData.teamColor})`;
                
                document.getElementById('scan-team-btn').disabled = true;
                document.getElementById('scan-team-btn').style.opacity = '0.5';
                
                const configBtn = document.getElementById('scan-config-btn');
                configBtn.disabled = false;
                configBtn.style.opacity = '1';
                
            } catch (err) {
                console.error('Error parsing team QR:', err);
                showError('Ongeldige QR-code: ' + err.message);
            }
        }
        
        // Start Config scan
        function startConfigScan() {
            if (!gameState.teamNumber) {
                showError('Scan eerst je Team QR!');
                return;
            }
            
            // Update status
            document.getElementById('status-icon').textContent = 'üî∑';
            document.getElementById('status-text').textContent = 'Config QR wordt gescand...';
            document.getElementById('scan-config-btn').disabled = true;
            
            const roleLabel = gameState.role === 'scout' ? 'Verkenner' : 'Team';
            const badge = document.getElementById('team-badge');
            badge.innerHTML = `
                <div class="success" style="margin-bottom: 15px;">
                    ‚úÖ <strong>${roleLabel} succesvol gescand!</strong><br>
                    Je bent: ${gameState.teamName} (${gameState.teamColor})
                </div>
            `;
            
            showScreen('screen-config-scan');
            
            gameState.scanner = new Html5QrcodeScanner(
                "qr-reader-config",
                { 
                    fps: 10,
                    qrbox: { width: 200, height: 200 },
                    aspectRatio: 1.0
                }
            );
            
            gameState.scanner.render(onConfigQRScanned, onScanError);
        }
        
        // Config QR scanned
        function onConfigQRScanned(decodedText) {
            console.log('Config QR scanned');
            
            try {
                const qrData = JSON.parse(decodedText);
                const decompressed = LZString.decompressFromBase64(qrData.data);
                const configData = JSON.parse(decompressed);
                
                if (configData.type !== 'config') {
                    showError('Dit is geen Config QR-code!');
                    return;
                }
                
                gameState.config = configData;
                gameState.gameStartTime = Date.now(); // Start timer
                
                const myCardKCodes = configData.distribution[`team${gameState.teamNumber}`];
                gameState.myCards = myCardKCodes.map(kcode => {
                    const cardInfo = configData.cards[kcode];
                    return {
                        kcode: kcode,
                        name: cardInfo.name,
                        type: cardInfo.type
                    };
                });
                
                gameState.scanner.clear();
                gameState.scanner = null;
                
                saveGameState();
                showScreen('screen-playing');

                if (gameState.role === 'scout') {
                    activateScoutUI();
                } else {
                    switchGameTab('my-cards-tab');
                    displayTeamInfo();
                    displayMyCards();
                }
                
            } catch (err) {
                console.error('Error parsing config QR:', err);
                showError('Ongeldige Config QR-code: ' + err.message);
            }
        }
        
        // Scan error (ignore most)
        function onScanError(errorMessage) {
            if (!errorMessage.includes('No MultiFormat Readers')) {
                console.log('Scan error:', errorMessage);
            }
        }
        
        // Cancel scan
        function cancelScan() {
            if (gameState.scanner) {
                gameState.scanner.clear();
                gameState.scanner = null;
            }
            
            // Reset status als team nog niet gescand is
            if (!gameState.teamNumber) {
                document.getElementById('status-icon').textContent = '‚è≥';
                document.getElementById('status-text').textContent = 'Wachtend op team scan...';
                document.getElementById('scan-team-btn').disabled = false;
                document.getElementById('scan-team-btn').style.opacity = '1';
            } else {
                // Team al gescand, houd status
                document.getElementById('status-icon').textContent = '‚úÖ';
                document.getElementById('status-text').innerHTML = `<strong>Team gescand!</strong> ${gameState.teamName} (${gameState.teamColor})`;
                document.getElementById('scan-team-btn').disabled = true;
                document.getElementById('scan-team-btn').style.opacity = '0.5';
                document.getElementById('scan-config-btn').disabled = false;
                document.getElementById('scan-config-btn').style.opacity = '1';
            }
            
            showScreen('screen-welcome');
        }
        
        // Back to welcome
        function backToWelcome() {
            if (gameState.scanner) {
                gameState.scanner.clear();
                gameState.scanner = null;
            }
            gameState.teamNumber = null;
            gameState.teamName = null;
            gameState.teamColor = null;
            
            // Reset status en knoppen
            document.getElementById('status-icon').textContent = '‚è≥';
            document.getElementById('status-text').textContent = 'Wachtend op team scan...';
            document.getElementById('scan-team-btn').disabled = false;
            document.getElementById('scan-team-btn').style.opacity = '1';
            document.getElementById('scan-config-btn').disabled = true;
            document.getElementById('scan-config-btn').style.opacity = '0.5';
            
            showScreen('screen-welcome');
        }
        
        // Display team info
        function displayTeamInfo() {
            const colorMap = {
                'Rood': '#dc3545',
                'Blauw': '#007bff',
                'Groen': '#28a745',
                'Geel': '#ffc107',
                'Paars': '#6f42c1',
                'Oranje': '#fd7e14'
            };
            const color = colorMap[gameState.teamColor] || '#667eea';
            
            const h1 = document.querySelector('h1');
            h1.style.setProperty('--team-color', color);
            h1.classList.add('team-colored');
            
            const style = document.createElement('style');
            style.id = 'team-color-style';
            const oldStyle = document.getElementById('team-color-style');
            if (oldStyle) oldStyle.remove();
            
            style.textContent = `
                .tab.active {
                    background: ${color} !important;
                }
                .btn:not(.btn-secondary) {
                    background: ${color} !important;
                }
                .btn:not(.btn-secondary):disabled {
                    background: ${color} !important;
                    opacity: 0.5;
                }
                h2, h3 {
                    color: ${color} !important;
                }
                .info-box {
                    border-left-color: ${color} !important;
                }
                .team-badge {
                    background: ${color} !important;
                }
            `;
            document.head.appendChild(style);
            
            const rotationDiv = document.getElementById('rotation-info');
            const checkOrder = getCheckOrder();
            const teamNames = checkOrder.map(num => `Team ${num}`);
            rotationDiv.innerHTML = `<strong>Controle volgorde:</strong><br>${teamNames.join(' ‚Üí ')}`;
        }
        
        // Get check order for this team
        function getCheckOrder() {
            const numTeams = Object.keys(gameState.config.distribution).length;
            const teams = [];
            for (let i = 1; i <= numTeams; i++) {
                teams.push(i);
            }
            
            const myIndex = teams.indexOf(gameState.teamNumber);
            return [...teams.slice(myIndex + 1), ...teams.slice(0, myIndex)];
        }
        
        // Display my cards
        function displayMyCards() {
            const container = document.getElementById('my-cards');
            container.innerHTML = '';
            
            gameState.myCards.forEach(card => {
                const icon = card.type === 'p' ? 'üë§' : card.type === 'w' ? 'üî™' : 'üè†';
                const div = document.createElement('div');
                div.style.cssText = 'background: #0f3460; padding: 10px; border-radius: 6px; margin: 5px 0;';
                div.textContent = `${icon} ${card.name}`;
                container.appendChild(div);
            });
        }
        
        // Reset app
        function resetApp() {
            if (!confirm('Weet je zeker dat je de app wilt resetten? Al je voortgang gaat verloren!')) {
                return;
            }
            performReset();
        }
        
        // Perform reset
        function performReset() {
            // 1. Stop any active scanners
            if (gameState.scanner) {
                try {
                    gameState.scanner.clear();
                } catch (e) {
                    console.log('Scanner already cleared');
                }
                gameState.scanner = null;
            }
            
            // 2. Stop penalty timer
            if (penaltyInterval) {
                clearInterval(penaltyInterval);
                penaltyInterval = null;
            }
            
            // 3. Close ALL modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.getElementById('penalty-overlay').classList.remove('active');
            document.getElementById('win-overlay').classList.remove('active');
            
            // Remove any confetti
            document.querySelectorAll('.confetti').forEach(c => c.remove());
            
            // 4. Show tabs again (in case hidden during accusation)
            document.getElementById('tabs-row-1').classList.remove('hidden');
            document.getElementById('tabs-row-2').classList.remove('hidden');
            document.getElementById('tabs-scout').classList.add('hidden');
            
            // 5. Clear suggestion display
            document.getElementById('suggestion-person').innerHTML = '<span class="empty">Scan kaart</span>';
            document.getElementById('suggestion-weapon').innerHTML = '<span class="empty">Scan kaart</span>';
            document.getElementById('suggestion-location').innerHTML = '<span class="empty">Scan kaart</span>';
            
            // Reset currentSuggestion in gameState
            gameState.currentSuggestion = {
                person: null,
                weapon: null,
                location: null
            };
            
            // 5b. Reset envelope modal
            document.getElementById('envelope-animation').classList.remove('hidden');
            document.getElementById('envelope-solution').classList.add('hidden');
            document.getElementById('envelope-result').classList.add('hidden');
            document.getElementById('envelope-title').textContent = 'De envelop wordt geopend...';
            document.getElementById('envelope-status').textContent = 'Even geduld...';
            document.getElementById('envelope-summary').innerHTML = '';
            
            // 5c. Reset accusation modal
            const accusationSelects = ['accusation-person', 'accusation-weapon', 'accusation-location'];
            accusationSelects.forEach(id => {
                const select = document.getElementById(id);
                if (select) select.selectedIndex = 0;
            });
            
            // 6. Remove team color styling
            const oldStyle = document.getElementById('team-color-style');
            if (oldStyle) oldStyle.remove();
            
            const h1 = document.querySelector('h1');
            h1.classList.remove('team-colored');
            h1.style.removeProperty('--team-color');
            
            // 7. Clear localStorage
            for (let i = 1; i <= 6; i++) {
                localStorage.removeItem(`cluedo_team${i}_state`);
                localStorage.removeItem(`cluedo_scout_team${i}_state`);
            }
            
            // 8. Reset gameState
            gameState = {
                role: null,
                teamNumber: null,
                teamName: null,
                teamColor: null,
                config: null,
                myCards: [],
                scoutLog: [],
                currentSuggestion: {
                    person: null,
                    weapon: null,
                    location: null
                },
                history: [],
                scanner: null,
                gameStartTime: null,
                penalty: {
                    active: false,
                    endTime: null,
                    reason: null
                },
                gameWon: {
                    won: false,
                    timestamp: null,
                    timeElapsed: null,
                    suggestionsCount: null,
                    solution: null
                }
            };
            
            // 9. Reset welcome screen buttons
            document.getElementById('status-icon').textContent = '‚è≥';
            document.getElementById('status-text').textContent = 'Wachtend op team scan...';
            document.getElementById('scan-team-btn').disabled = false;
            document.getElementById('scan-team-btn').style.opacity = '1';
            document.getElementById('scan-config-btn').disabled = true;
            document.getElementById('scan-config-btn').style.opacity = '0.5';
            
            // 9b. Reset history display
            document.getElementById('history-list').innerHTML = `
                <div class="info-box">
                    <p style="text-align: center; color: #999;">Nog geen geschiedenis</p>
                </div>
            `;
            
            // 9c. Reset my cards display
            document.getElementById('my-cards').innerHTML = '';
            
            // 10. Go to welcome screen
            showScreen('screen-welcome');
            
            // 11. Reset button states (NA showScreen)
            document.getElementById('check-suggestion-btn').disabled = true;
            const accusationBtn = document.getElementById('scan-accusation-btn');
            if (accusationBtn) {
                accusationBtn.disabled = false;
                accusationBtn.style.opacity = '1';
            }
            
            console.log('‚úÖ Complete reset successful');

            // 12. Force hard reload to pick up latest version from server
            window.location.reload(true);
        }
        
        // ========== SCOUT FUNCTIES ==========

        let scoutScannerActive = false;
        let scoutProgress = 0;
        let scoutDelay = 10;
        let scoutCurrentCard = null;
        let scoutPendingCard = null;
        let scoutLostTimer = null;
        let scoutLostCount = 0;

        function activateScoutUI() {
            document.getElementById('tabs-row-1').classList.add('hidden');
            document.getElementById('tabs-row-2').classList.add('hidden');
            document.getElementById('tabs-scout').classList.remove('hidden');
            displayTeamInfo();
            // Teamkleur ook op de voortgangsbalk
            const colorMap = { 'Rood':'#dc3545','Blauw':'#007bff','Groen':'#28a745','Geel':'#ffc107','Paars':'#6f42c1','Oranje':'#fd7e14' };
            const color = colorMap[gameState.teamColor] || '#667eea';
            const bar = document.getElementById('scout-progress-bar');
            if (bar) bar.style.background = color;
            renderScoutLog();
            switchGameTab('scout-decoder-tab');
        }

        function startScoutScan() {
            scoutDelay = (gameState.config && gameState.config.settings && gameState.config.settings.scoutScanDelay)
                ? gameState.config.settings.scoutScanDelay : 10;
            scoutProgress = 0;
            scoutCurrentCard = null;
            scoutScannerActive = true;

            document.getElementById('scout-alert').classList.add('hidden');
            updateScoutProgressBar(0);
            document.getElementById('scout-scan-modal').classList.add('active');

            gameState.scanner = new Html5QrcodeScanner(
                'qr-reader-scout',
                { fps: 10, qrbox: { width: 200, height: 200 }, aspectRatio: 1.0 }
            );
            gameState.scanner.render(onScoutQRScanned, onScoutScanError);
        }

        function onScoutQRScanned(decodedText) {
            if (!scoutScannerActive) return;
            try {
                const qrData = JSON.parse(decodedText);
                const decompressed = LZString.decompressFromBase64(qrData.data);
                const cardData = JSON.parse(decompressed);

                if (cardData.type !== 'card' || !cardData.id || !/^K\d+$/.test(cardData.id)) {
                    if (!scoutCurrentCard || scoutCurrentCard.id !== '__invalid__') {
                        scoutCurrentCard = { id: '__invalid__' };
                        const countdown = document.getElementById('scout-recovery-countdown');
                        if (countdown) countdown.textContent = 'Kaart onleesbaar voor decoder';
                        document.getElementById('scout-alert').classList.remove('hidden');
                        setTimeout(() => document.getElementById('scout-alert').classList.add('hidden'), 3000);
                    }
                    return;
                }

                if (!scoutCurrentCard || scoutCurrentCard.id !== cardData.id) {
                    scoutCurrentCard = cardData;
                    scoutProgress = 0;
                    clearScoutLostTimer();
                    document.getElementById('scout-alert').classList.add('hidden');
                }

                clearScoutLostTimer();
                document.getElementById('scout-alert').classList.add('hidden');

                const increment = 100 / (scoutDelay * 10);
                scoutProgress = Math.min(100, scoutProgress + increment);
                updateScoutProgressBar(scoutProgress);

                if (scoutProgress >= 100) {
                    scoutScannerActive = false;
                    showScoutCardResult(cardData.id);
                }
            } catch (err) { /* ignore */ }
        }

        function onScoutScanError(msg) {
            if (!scoutScannerActive || !scoutCurrentCard || scoutCurrentCard.id === '__invalid__') return;
            if (msg && msg.includes('No MultiFormat') && !scoutLostTimer) {
                startScoutLostTimer();
            }
        }

        function startScoutLostTimer() {
            scoutLostCount = 5;
            document.getElementById('scout-alert').classList.remove('hidden');
            updateScoutRecovery();
            scoutLostTimer = setInterval(() => {
                scoutLostCount--;
                updateScoutRecovery();
                if (scoutLostCount <= 0) {
                    clearScoutLostTimer();
                    scoutProgress = 0;
                    scoutCurrentCard = null;
                    updateScoutProgressBar(0);
                    document.getElementById('scout-alert').classList.add('hidden');
                }
            }, 1000);
        }

        function updateScoutRecovery() {
            const el = document.getElementById('scout-recovery-countdown');
            if (el) el.textContent = `Richt opnieuw! Nog ${scoutLostCount}s...`;
        }

        function clearScoutLostTimer() {
            if (scoutLostTimer) { clearInterval(scoutLostTimer); scoutLostTimer = null; }
        }

        function updateScoutProgressBar(pct) {
            const bar = document.getElementById('scout-progress-bar');
            const label = document.getElementById('scout-progress-pct');
            if (bar) bar.style.width = Math.round(pct) + '%';
            if (label) label.textContent = Math.round(pct) + '%';
        }

        function showScoutCardResult(kcode) {
            clearScoutLostTimer();
            if (gameState.scanner) {
                try { gameState.scanner.clear(); } catch(e) {}
                gameState.scanner = null;
            }
            const cardInfo = gameState.config && gameState.config.cards && gameState.config.cards[kcode];
            if (!cardInfo) {
                showError('Kaart ' + kcode + ' niet gevonden in configuratie.');
                cancelScoutScan();
                return;
            }
            scoutPendingCard = { kcode, name: cardInfo.name, type: cardInfo.type, timestamp: Date.now() };
            const icon = cardInfo.type === 'p' ? 'üë§' : cardInfo.type === 'w' ? 'üî™' : 'üè†';
            const typeLabel = cardInfo.type === 'p' ? 'Persoon' : cardInfo.type === 'w' ? 'Wapen' : 'Locatie';
            document.getElementById('scout-card-icon').textContent = icon;
            document.getElementById('scout-card-name').textContent = cardInfo.name;
            document.getElementById('scout-card-type').textContent = typeLabel;
            document.getElementById('scout-scan-modal').classList.remove('active');
            document.getElementById('scout-card-modal').classList.add('active');
        }

        function addToScoutLog() {
            if (!scoutPendingCard) return;
            if (!gameState.scoutLog) gameState.scoutLog = [];
            gameState.scoutLog.push(scoutPendingCard);
            saveGameState();
            renderScoutLog();
            document.getElementById('scout-card-modal').classList.remove('active');
            scoutPendingCard = null;
            switchGameTab('scout-log-tab');
        }

        function closeScoutCardModal() {
            document.getElementById('scout-card-modal').classList.remove('active');
            scoutPendingCard = null;
        }

        function cancelScoutScan() {
            scoutScannerActive = false;
            clearScoutLostTimer();
            if (gameState.scanner) {
                try { gameState.scanner.clear(); } catch(e) {}
                gameState.scanner = null;
            }
            scoutProgress = 0;
            scoutCurrentCard = null;
            updateScoutProgressBar(0);
            document.getElementById('scout-scan-modal').classList.remove('active');
        }

        function renderScoutLog() {
            const container = document.getElementById('scout-log-list');
            if (!container) return;
            const log = gameState.scoutLog || [];
            if (log.length === 0) {
                container.innerHTML = '<div class="info-box"><p style="text-align:center; color:#999;">Nog niets gedecodeerd</p></div>';
                return;
            }
            container.innerHTML = log.slice().reverse().map(entry => {
                const icon = entry.type === 'p' ? 'üë§' : entry.type === 'w' ? 'üî™' : 'üè†';
                const typeLabel = entry.type === 'p' ? 'Persoon' : entry.type === 'w' ? 'Wapen' : 'Locatie';
                const time = new Date(entry.timestamp).toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                return `<div class="checking-item">
                    <span style="font-size:1.5em;">${icon}</span>
                    <div style="flex:1; margin-left:12px;">
                        <div style="font-weight:600; color:white;">${entry.name}</div>
                        <div style="font-size:0.85em; color:#999;">${typeLabel} &bull; ${time}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // ========== SUGGESTIE FUNCTIES ==========
        
        // Switch game tab
        function switchGameTab(tabId) {
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            const tabs = document.querySelectorAll('.tabs .tab');
            tabs.forEach(tab => {
                if (tab.getAttribute('onclick').includes(tabId)) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'history-tab') {
                renderHistory();
            }
        }
        
        // Render history
        function renderHistory() {
            const container = document.getElementById('history-list');
            
            if (gameState.history.length === 0) {
                container.innerHTML = `
                    <div class="info-box">
                        <p style="text-align: center; color: #999;">Nog geen geschiedenis</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            [...gameState.history].reverse().forEach(entry => {
                const time = new Date(entry.timestamp).toLocaleTimeString('nl-NL', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const div = document.createElement('div');
                div.className = 'checking-item';
                div.style.flexDirection = 'column';
                div.style.alignItems = 'flex-start';
                
                if (entry.type === 'suggestion') {
                    let html = `
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 10px;">${time} - SUGGESTIE</div>
                        <div style="font-size: 0.9em; margin-bottom: 8px;">
                            üë§ ${entry.suggestion.person.name}<br>
                            üî™ ${entry.suggestion.weapon.name}<br>
                            üè† ${entry.suggestion.location.name}
                        </div>
                    `;
                    
                    if (entry.result.noMatch) {
                        html += `<div style="color: #4caf50; font-weight: 600;">üéØ Geen team had deze kaarten!</div>`;
                    } else {
                        html += `<div style="color: #999;">‚Üí Team ${entry.result.team} toonde:</div>`;
                        entry.result.cards.forEach(card => {
                            const icon = card.type === 'p' ? 'üë§' : card.type === 'w' ? 'üî™' : 'üè†';
                            html += `<div style="margin-left: 15px; color: white;">${icon} ${card.name}</div>`;
                        });
                    }
                    
                    div.innerHTML = html;
                } else if (entry.type === 'accusation') {
                    let html = `
                        <div style="font-weight: 600; color: #667eea; margin-bottom: 10px;">${time} - BESCHULDIGING</div>
                        <div style="font-size: 0.9em; margin-bottom: 8px;">
                            üë§ ${entry.accusation.person.name}<br>
                            üî™ ${entry.accusation.weapon.name}<br>
                            üè† ${entry.accusation.location.name}
                        </div>
                    `;
                    
                    if (entry.result.correct) {
                        html += `<div style="color: #4caf50; font-weight: 600;">üèÜ GEWONNEN!</div>`;
                        html += `<div style="color: #999; margin-top: 5px;">‚è±Ô∏è Tijd: ${formatTime(entry.result.timeElapsed)}</div>`;
                        html += `<div style="color: #999;">üìù Suggesties: ${entry.result.suggestionsCount}</div>`;
                    } else {
                        html += `<div style="color: #ff6b6b; font-weight: 600;">‚ùå ONJUIST - Penalty ontvangen</div>`;
                    }
                    
                    div.innerHTML = html;
                }
                
                container.appendChild(div);
            });
        }
        
        let scannedCardData = null;
        
        // Scan card
        function scanCard() {
            document.getElementById('card-scan-modal').classList.add('active');
            
            gameState.scanner = new Html5QrcodeScanner(
                "qr-reader-card",
                { 
                    fps: 10,
                    qrbox: { width: 200, height: 200 }
                }
            );
            
            gameState.scanner.render(onCardScanned, onScanError);
        }
        
        // Card scanned
        function onCardScanned(decodedText) {
            console.log('Card scanned');
            
            try {
                const qrData = JSON.parse(decodedText);
                const decompressed = LZString.decompressFromBase64(qrData.data);
                const cardData = JSON.parse(decompressed);
                
                if (cardData.type !== 'card') {
                    showError('Dit is geen kaart QR-code!');
                    return;
                }
                
                const kcode = cardData.id;
                const cardInfo = gameState.config.cards[kcode];
                
                if (!cardInfo) {
                    showError('Onbekende kaart: ' + kcode);
                    return;
                }
                
                scannedCardData = {
                    kcode: kcode,
                    name: cardInfo.name,
                    type: cardInfo.type
                };
                
                gameState.scanner.clear();
                gameState.scanner = null;
                
                showCardConfirm();
                
            } catch (err) {
                console.error('Error parsing card QR:', err);
                showError('Ongeldige kaart QR-code: ' + err.message);
            }
        }
        
        // Show card confirm modal
        function showCardConfirm() {
            const card = scannedCardData;
            const typeNames = { p: 'Persoon', w: 'Wapen', l: 'Locatie' };
            const icons = { p: 'üë§', w: 'üî™', l: 'üè†' };
            
            document.getElementById('confirm-card-icon').textContent = icons[card.type];
            document.getElementById('confirm-card-name').textContent = card.name;
            document.getElementById('confirm-card-type').textContent = typeNames[card.type];
            
            const currentCard = gameState.currentSuggestion[
                card.type === 'p' ? 'person' : card.type === 'w' ? 'weapon' : 'location'
            ];
            
            const isOwnCard = gameState.myCards.some(c => c.kcode === card.kcode);
            
            let message = 'Toevoegen aan suggestie?';
            
            if (currentCard) {
                message = `Je hebt al een ${typeNames[card.type].toLowerCase()}: <strong>${currentCard.name}</strong><br>Wil je deze vervangen?`;
            }
            
            if (isOwnCard) {
                message += '<br><br>‚ö†Ô∏è <strong>Dit is een van jullie eigen kaarten!</strong>';
            }
            
            document.getElementById('confirm-message').innerHTML = message;
            
            document.getElementById('card-scan-modal').classList.remove('active');
            document.getElementById('card-confirm-modal').classList.add('active');
        }
        
        // Confirm add card
        function confirmAddCard() {
            const card = scannedCardData;
            
            if (card.type === 'p') {
                gameState.currentSuggestion.person = card;
                document.getElementById('suggestion-person').innerHTML = 
                    `<span>${card.name}</span>`;
            } else if (card.type === 'w') {
                gameState.currentSuggestion.weapon = card;
                document.getElementById('suggestion-weapon').innerHTML = 
                    `<span>${card.name}</span>`;
            } else if (card.type === 'l') {
                gameState.currentSuggestion.location = card;
                document.getElementById('suggestion-location').innerHTML = 
                    `<span>${card.name}</span>`;
            }
            
            updateCheckButton();
            closeCardConfirm();
            saveGameState();
        }
        
        // Update check button
        function updateCheckButton() {
            const btn = document.getElementById('check-suggestion-btn');
            const complete = gameState.currentSuggestion.person && 
                           gameState.currentSuggestion.weapon && 
                           gameState.currentSuggestion.location;
            
            btn.disabled = !complete || gameState.gameWon.won;
        }
        
        // Close card scan
        function closeCardScan() {
            if (gameState.scanner) {
                gameState.scanner.clear();
                gameState.scanner = null;
            }
            document.getElementById('card-scan-modal').classList.remove('active');
        }
        
        // Close card confirm
        function closeCardConfirm() {
            document.getElementById('card-confirm-modal').classList.remove('active');
            scannedCardData = null;
        }
        
        // Check suggestion with animation
        async function checkSuggestion() {
            const suggestion = gameState.currentSuggestion;
            
            document.getElementById('checking-modal').classList.add('active');
            const checkingList = document.getElementById('checking-list');
            checkingList.innerHTML = '';
            
            const checkOrder = getCheckOrder();
            
            let matchFound = false;
            let matchTeam = null;
            
            for (const teamNum of checkOrder) {
                const item = document.createElement('div');
                item.className = 'checking-item';
                item.innerHTML = `
                    <div class="team-label">Team ${teamNum}</div>
                    <div class="status">
                        <span class="checking-dots">Controleren</span>
                    </div>
                `;
                checkingList.appendChild(item);
                
                await new Promise(resolve => setTimeout(resolve, 4000));
                
                const teamCards = gameState.config.distribution[`team${teamNum}`];
                const hasCard = teamCards.some(kcode => 
                    kcode === suggestion.person.kcode ||
                    kcode === suggestion.weapon.kcode ||
                    kcode === suggestion.location.kcode
                );
                
                const statusDiv = item.querySelector('.status');
                if (hasCard) {
                    statusDiv.innerHTML = '<span class="check-result has-card">‚úÖ Heeft een kaart!</span>';
                    matchFound = true;
                    matchTeam = teamNum;
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    break;
                } else {
                    statusDiv.innerHTML = '<span class="check-result no-card">‚ùå Geen kaarten</span>';
                }
                
                await new Promise(resolve => setTimeout(resolve, 800));
            }
            
            document.getElementById('checking-modal').classList.remove('active');
            
            if (matchFound) {
                document.getElementById('team-check-message').textContent = 
                    `Team ${matchTeam} heeft een kaart!`;
                
                gameState.currentCheckTeam = matchTeam;
                
                document.getElementById('qr-reader-team-check').classList.add('hidden');
                document.getElementById('start-team-scan-btn').classList.remove('hidden');
                
                document.getElementById('team-check-modal').classList.add('active');
                
            } else {
                checkingList.innerHTML += `
                    <div class="success" style="margin-top: 20px; text-align: center;">
                        <strong>üéØ Geen van de teams heeft deze kaarten!</strong><br>
                        <span style="font-size: 0.9em;">Heb je de juiste oplossing gevonden?</span>
                    </div>
                `;
                
                document.getElementById('checking-modal').classList.add('active');
                
                await new Promise(resolve => setTimeout(resolve, 3000));
                document.getElementById('checking-modal').classList.remove('active');
                
                showSuggestionResult(null);
            }
        }
        
        // Start team check scan
        function startTeamCheckScan() {
            if (gameState.scanner) {
                try {
                    gameState.scanner.clear();
                } catch (e) {
                    console.log('Error clearing scanner:', e);
                }
                gameState.scanner = null;
            }
            
            document.getElementById('start-team-scan-btn').classList.add('hidden');
            document.getElementById('qr-reader-team-check').classList.remove('hidden');
            
            setTimeout(() => {
                gameState.scanner = new Html5QrcodeScanner(
                    "qr-reader-team-check",
                    { 
                        fps: 10,
                        qrbox: { width: 200, height: 200 }
                    }
                );
                
                gameState.scanner.render(onTeamCheckScanned, onScanError);
            }, 100);
        }
        
        // Team check scanned
        function onTeamCheckScanned(decodedText) {
            try {
                const qrData = JSON.parse(decodedText);
                const decompressed = LZString.decompressFromBase64(qrData.data);
                const teamData = JSON.parse(decompressed);
                
                if (teamData.type !== 'team') {
                    showError('Dit is geen Team QR-code!');
                    return;
                }
                
                if (teamData.teamNumber !== gameState.currentCheckTeam) {
                    showError(`Dit is Team ${teamData.teamNumber}, je moet Team ${gameState.currentCheckTeam} scannen!`);
                    return;
                }
                
                gameState.scanner.clear();
                gameState.scanner = null;
                
                document.getElementById('team-check-modal').classList.remove('active');
                
                showSuggestionResult(teamData.teamNumber);
                
            } catch (err) {
                console.error('Error parsing team QR:', err);
                showError('Ongeldige Team QR-code');
            }
        }
        
        // Show suggestion result
        function showSuggestionResult(matchTeam) {
            const suggestion = gameState.currentSuggestion;
            
            document.getElementById('result-person').textContent = `üë§ ${suggestion.person.name}`;
            document.getElementById('result-weapon').textContent = `üî™ ${suggestion.weapon.name}`;
            document.getElementById('result-location').textContent = `üè† ${suggestion.location.name}`;
            
            const resultMsg = document.getElementById('result-message');
            
            if (matchTeam) {
                const teamCards = gameState.config.distribution[`team${matchTeam}`];
                const matches = [];
                
                if (teamCards.includes(suggestion.person.kcode)) matches.push(suggestion.person);
                if (teamCards.includes(suggestion.weapon.kcode)) matches.push(suggestion.weapon);
                if (teamCards.includes(suggestion.location.kcode)) matches.push(suggestion.location);
                
                matches.sort((a, b) => {
                    const numA = parseInt(a.kcode.substring(1));
                    const numB = parseInt(b.kcode.substring(1));
                    return numA - numB;
                });
                
                const maxShow = gameState.config.settings.maxCardsToShow;
                const cardsToShow = matches.slice(0, maxShow);
                
                let html = `<div class="success">‚úÖ Team ${matchTeam} toont:</div>`;
                html += '<div style="margin: 15px 0;">';
                cardsToShow.forEach(card => {
                    const icon = card.type === 'p' ? 'üë§' : card.type === 'w' ? 'üî™' : 'üè†';
                    html += `<div style="background: #0f3460; padding: 10px; border-radius: 6px; margin: 5px 0;">${icon} ${card.name}</div>`;
                });
                html += '</div>';
                
                if (matches.length > maxShow) {
                    html += '<div class="info-box">Dit team kan meer kaarten hebben. Maximaal ' + maxShow + ' kaarten worden getoond.</div>';
                } else {
                    html += '<div class="info-box">Dit zijn alle kaarten die dit team heeft van deze suggestie.</div>';
                }
                
                resultMsg.innerHTML = html;
                
                gameState.history.push({
                    timestamp: Date.now(),
                    type: 'suggestion',
                    suggestion: {...suggestion},
                    result: {
                        team: matchTeam,
                        cards: cardsToShow
                    }
                });
                
            } else {
                resultMsg.innerHTML = `
                    <div class="info-box" style="background: #2e7d32; border-left-color: #4caf50;">
                        üéØ <strong>Geen team heeft deze kaarten!</strong><br>
                        Dit zijn mogelijk oplossingskaarten!
                    </div>
                `;
                
                gameState.history.push({
                    timestamp: Date.now(),
                    type: 'suggestion',
                    suggestion: {...suggestion},
                    result: {
                        noMatch: true
                    }
                });
            }
            
            document.getElementById('suggestion-result-modal').classList.add('active');
            
            saveGameState();
        }
        
        // Close result modal
        function closeResultModal() {
            document.getElementById('suggestion-result-modal').classList.remove('active');
            
            gameState.currentSuggestion = {
                person: null,
                weapon: null,
                location: null
            };
            
            document.getElementById('suggestion-person').innerHTML = '<span class="empty">Scan een kaart</span>';
            document.getElementById('suggestion-weapon').innerHTML = '<span class="empty">Scan een kaart</span>';
            document.getElementById('suggestion-location').innerHTML = '<span class="empty">Scan een kaart</span>';
            
            updateCheckButton();
            saveGameState();
        }
        
        // Close team check
        function closeTeamCheck() {
            if (gameState.scanner) {
                gameState.scanner.clear();
                gameState.scanner = null;
            }
            document.getElementById('team-check-modal').classList.remove('active');
        }
        
        // ========== BESCHULDIGING FUNCTIES ==========
        
        // Start accusation scan
        function startAccusationScan() {
            document.getElementById('accusation-scan-modal').classList.add('active');
            
            gameState.scanner = new Html5QrcodeScanner(
                "qr-reader-accusation",
                { 
                    fps: 10,
                    qrbox: { width: 200, height: 200 }
                }
            );
            
            gameState.scanner.render(onAccusationQRScanned, onScanError);
        }
        
        // Accusation QR scanned
        function onAccusationQRScanned(decodedText) {
            console.log('Accusation QR scanned');
            
            try {
                const qrData = JSON.parse(decodedText);
                const decompressed = LZString.decompressFromBase64(qrData.data);
                const accusationData = JSON.parse(decompressed);
                
                if (accusationData.type !== 'accusation') {
                    showError('Dit is geen Beschuldigings QR-code!');
                    return;
                }
                
                gameState.scanner.clear();
                gameState.scanner = null;
                
                document.getElementById('accusation-scan-modal').classList.remove('active');
                
                showAccusationModal();
                
            } catch (err) {
                console.error('Error parsing accusation QR:', err);
                showError('Ongeldige Beschuldigings QR-code: ' + err.message);
            }
        }
        
        // Show accusation modal
        function showAccusationModal() {
            // Hide tabs
            document.getElementById('tabs-row-1').classList.add('hidden');
            document.getElementById('tabs-row-2').classList.add('hidden');
            
            // Populate dropdowns
            const personSelect = document.getElementById('accusation-person');
            const weaponSelect = document.getElementById('accusation-weapon');
            const locationSelect = document.getElementById('accusation-location');
            
            personSelect.innerHTML = '<option value="">Kies persoon...</option>';
            weaponSelect.innerHTML = '<option value="">Kies wapen...</option>';
            locationSelect.innerHTML = '<option value="">Kies locatie...</option>';
            
            Object.entries(gameState.config.cards).forEach(([kcode, card]) => {
                if (card.type === 'p') {
                    personSelect.innerHTML += `<option value="${kcode}">${card.name}</option>`;
                } else if (card.type === 'w') {
                    weaponSelect.innerHTML += `<option value="${kcode}">${card.name}</option>`;
                } else if (card.type === 'l') {
                    locationSelect.innerHTML += `<option value="${kcode}">${card.name}</option>`;
                }
            });
            
            // Set penalty warning FIRST
            document.getElementById('penalty-warning').textContent = gameState.config.settings.penaltyMinutes;
            
            // Show modal
            document.getElementById('accusation-modal').classList.add('active');
            
            updateAccusationButton();
        }
        
        // Update accusation button
        function updateAccusationButton() {
            const person = document.getElementById('accusation-person').value;
            const weapon = document.getElementById('accusation-weapon').value;
            const location = document.getElementById('accusation-location').value;
            
            const btn = document.getElementById('confirm-accusation-btn');
            btn.disabled = !person || !weapon || !location;
        }
        
        // Close accusation scan
        function closeAccusationScan() {
            if (gameState.scanner) {
                gameState.scanner.clear();
                gameState.scanner = null;
            }
            document.getElementById('accusation-scan-modal').classList.remove('active');
        }
        
        // Close accusation modal
        function closeAccusationModal() {
            document.getElementById('accusation-modal').classList.remove('active');
            
            // Show tabs again
            document.getElementById('tabs-row-1').classList.remove('hidden');
            document.getElementById('tabs-row-2').classList.remove('hidden');
        }
        
        // Show double check
        function showDoubleCheck() {
            const personKcode = document.getElementById('accusation-person').value;
            const weaponKcode = document.getElementById('accusation-weapon').value;
            const locationKcode = document.getElementById('accusation-location').value;
            
            const personName = gameState.config.cards[personKcode].name;
            const weaponName = gameState.config.cards[weaponKcode].name;
            const locationName = gameState.config.cards[locationKcode].name;
            
            const summary = document.getElementById('double-check-summary');
            summary.innerHTML = `
                <strong>üë§ ${personName}</strong><br>
                <strong>üî™ ${weaponName}</strong><br>
                <strong>üè† ${locationName}</strong>
            `;
            
            // Update penalty text met enkelvoud/meervoud
            const penaltyMinutes = gameState.config.settings.penaltyMinutes;
            const penaltyText = document.getElementById('double-check-penalty-text');
            if (penaltyMinutes === 1) {
                penaltyText.innerHTML = '‚ùå <strong>Fout = Penalty van 1 minuut!</strong>';
            } else {
                penaltyText.innerHTML = `‚ùå <strong>Fout = Penalty van ${penaltyMinutes} minuten!</strong>`;
            }
            
            document.getElementById('accusation-modal').classList.remove('active');
            document.getElementById('double-check-modal').classList.add('active');
        }
        
        // Close double check
        function closeDoubleCheck() {
            document.getElementById('double-check-modal').classList.remove('active');
            document.getElementById('accusation-modal').classList.add('active');
        }
        
        // Start envelope opening animation
        async function startEnvelopeOpening() {
            // Close double check, open envelope modal
            document.getElementById('double-check-modal').classList.remove('active');
            
            // Force reflow to ensure modal is closed before opening new one
            void document.getElementById('double-check-modal').offsetHeight;
            
            document.getElementById('envelope-modal').classList.add('active');
            
            // Force reflow again
            void document.getElementById('envelope-modal').offsetHeight;
            
            // Get accusation data
            const personKcode = document.getElementById('accusation-person').value;
            const weaponKcode = document.getElementById('accusation-weapon').value;
            const locationKcode = document.getElementById('accusation-location').value;
            
            const personName = gameState.config.cards[personKcode].name;
            const weaponName = gameState.config.cards[weaponKcode].name;
            const locationName = gameState.config.cards[locationKcode].name;
            
            // Hide tabs during accusation
            document.getElementById('tabs-row-1').classList.add('hidden');
            document.getElementById('tabs-row-2').classList.add('hidden');
            
            // Phase 1: Opening envelope (3 sec)
            document.getElementById('envelope-title').textContent = 'De envelop wordt geopend...';
            await sleep(3000);
            
            // Phase 2: Controleren
            document.getElementById('envelope-title').textContent = 'Controleren...';
            document.getElementById('envelope-animation').classList.add('hidden');
            document.getElementById('envelope-solution').classList.remove('hidden');
            
            // Direct content tonen (geen lege balk meer)
            
            // Phase 3: Check INDIVIDUALLY met animatie (3x5 sec = 15 sec total)
            
            // Check person (5 sec met loading dots)
            document.getElementById('envelope-summary').innerHTML = `
                <div class="info-box" style="background: #0f3460; padding: 20px; border-radius: 8px;">
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 10px;">üë§ PERSOON</div>
                    <div style="font-size: 1.4em; color: white; margin: 10px 0; display: flex; align-items: center; justify-content: center;">
                        <strong>${personName}</strong>
                        <span class="loading-dots"></span>
                    </div>
                </div>
            `;
            await sleep(5000);
            
            // Check weapon (5 sec met loading dots)
            document.getElementById('envelope-summary').innerHTML = `
                <div class="info-box" style="background: #0f3460; padding: 20px; border-radius: 8px;">
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 10px;">üî™ WAPEN</div>
                    <div style="font-size: 1.4em; color: white; margin: 10px 0; display: flex; align-items: center; justify-content: center;">
                        <strong>${weaponName}</strong>
                        <span class="loading-dots"></span>
                    </div>
                </div>
            `;
            await sleep(5000);
            
            // Check location (5 sec met loading dots)
            document.getElementById('envelope-summary').innerHTML = `
                <div class="info-box" style="background: #0f3460; padding: 20px; border-radius: 8px;">
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 10px;">üè† LOCATIE</div>
                    <div style="font-size: 1.4em; color: white; margin: 10px 0; display: flex; align-items: center; justify-content: center;">
                        <strong>${locationName}</strong>
                        <span class="loading-dots"></span>
                    </div>
                </div>
            `;
            await sleep(5000);
            
            // Phase 4: Dramatic reveal met trommel
            const solution = gameState.config.solution;
            const isCorrect = solution.includes(personKcode) && 
                            solution.includes(weaponKcode) && 
                            solution.includes(locationKcode);
            
            document.getElementById('envelope-title').textContent = '‚öñÔ∏è Het oordeel...';
            document.getElementById('envelope-summary').innerHTML = `
                <div style="color: #999; margin-bottom: 15px;">Jullie beschuldiging is...</div>
                <div style="font-size: 3em; margin: 30px 0;">ü•Å</div>
            `;
            
            await sleep(3000);
            
            // Clear summary
            document.getElementById('envelope-summary').innerHTML = '';
            
            const resultDiv = document.getElementById('envelope-result');
            resultDiv.classList.remove('hidden');
            
            // Geen animatie - direct tonen
            resultDiv.style.opacity = '1';
            resultDiv.style.transform = 'scale(1)';
            
            if (isCorrect) {
                resultDiv.innerHTML = '<div style="color: #4caf50; font-size: 2.5em; font-weight: bold;">‚úÖ JUIST!</div>';
            } else {
                resultDiv.innerHTML = '<div style="color: #ff6b6b; font-size: 2.5em; font-weight: bold;">‚ùå ONJUIST!</div>';
            }
            
            await sleep(3000);
            
            // Close envelope modal
            document.getElementById('envelope-modal').classList.remove('active');
            
            // Show tabs again
            document.getElementById('tabs-row-1').classList.remove('hidden');
            document.getElementById('tabs-row-2').classList.remove('hidden');
            
            // Reset envelope modal for next time
            document.getElementById('envelope-animation').classList.remove('hidden');
            document.getElementById('envelope-solution').classList.remove('hidden');
            document.getElementById('envelope-result').classList.add('hidden');
            document.getElementById('envelope-title').textContent = 'De envelop wordt geopend...';
            document.getElementById('envelope-status').textContent = 'Even geduld...';
            
            // Store accusation data
            const accusation = {
                person: {
                    kcode: personKcode,
                    name: personName,
                    type: 'p'
                },
                weapon: {
                    kcode: weaponKcode,
                    name: weaponName,
                    type: 'w'
                },
                location: {
                    kcode: locationKcode,
                    name: locationName,
                    type: 'l'
                }
            };
            
            // Show result
            if (isCorrect) {
                handleCorrectAccusation(accusation);
            } else {
                handleWrongAccusation(accusation);
            }
        }
        
        // Sleep helper function for better async handling
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // Check accusation (OLD - not used anymore, kept for backwards compatibility)
        function checkAccusation() {
            startEnvelopeOpening();
        }
        
        // Handle correct accusation
        function handleCorrectAccusation(accusation) {
            const timeElapsed = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            const suggestionsCount = gameState.history.filter(e => e.type === 'suggestion').length;
            
            gameState.gameWon = {
                won: true,
                timestamp: Date.now(),
                timeElapsed: timeElapsed,
                suggestionsCount: suggestionsCount,
                solution: accusation
            };
            
            // Add to history
            gameState.history.push({
                timestamp: Date.now(),
                type: 'accusation',
                accusation: accusation,
                result: {
                    correct: true,
                    timeElapsed: timeElapsed,
                    suggestionsCount: suggestionsCount
                }
            });
            
            saveGameState();
            
            showWinScreen();
        }
        
        // Show win screen
        function showWinScreen() {
            // Add confetti to body (not win-content)
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 3) + 's';
                document.body.appendChild(confetti);
            }
            
            document.getElementById('win-time').textContent = formatTime(gameState.gameWon.timeElapsed);
            document.getElementById('win-suggestions').textContent = gameState.gameWon.suggestionsCount;
            
            document.getElementById('win-overlay').classList.add('active');
            
            // Enable button after 5 seconds
            let countdown = 5;
            const updateTimer = () => {
                if (countdown > 0) {
                    document.getElementById('win-timer-text').textContent = `(knop actief over ${countdown} sec)`;
                    countdown--;
                    setTimeout(updateTimer, 1000);
                } else {
                    document.getElementById('win-continue-btn').disabled = false;
                    document.getElementById('win-timer-text').style.display = 'none';
                }
            };
            updateTimer();
        }
        
        // Close win screen
        function closeWinScreen() {
            document.getElementById('win-overlay').classList.remove('active');
            
            // Remove confetti
            document.querySelectorAll('.confetti').forEach(c => c.remove());
            
            switchGameTab('history-tab');
            updateButtonStates();
        }
        
        // Handle wrong accusation
        function handleWrongAccusation(accusation) {
            const penaltyMinutes = gameState.config.settings.penaltyMinutes;
            const penaltyEndTime = Date.now() + (penaltyMinutes * 60 * 1000);
            
            gameState.penalty = {
                active: true,
                endTime: penaltyEndTime,
                reason: 'wrong_accusation'
            };
            
            // Add to history
            gameState.history.push({
                timestamp: Date.now(),
                type: 'accusation',
                accusation: accusation,
                result: {
                    correct: false
                }
            });
            
            saveGameState();
            
            startPenaltyTimer();
        }
        
        // Start penalty timer
        function startPenaltyTimer() {
            document.getElementById('penalty-overlay').classList.add('active');
            
            if (penaltyInterval) {
                clearInterval(penaltyInterval);
            }
            
            const updateTimer = () => {
                const now = Date.now();
                const remaining = Math.max(0, Math.floor((gameState.penalty.endTime - now) / 1000));
                
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                
                document.getElementById('penalty-timer').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                document.getElementById('penalty-seconds').textContent = remaining;
                
                if (remaining <= 0) {
                    clearInterval(penaltyInterval);
                    gameState.penalty.active = false;
                    saveGameState();
                    
                    document.getElementById('penalty-overlay').classList.remove('active');
                    document.getElementById('penalty-end-modal').classList.add('active');
                }
            };
            
            updateTimer();
            penaltyInterval = setInterval(updateTimer, 1000);
        }
        
        // Close penalty end
        function closePenaltyEnd() {
            document.getElementById('penalty-end-modal').classList.remove('active');
            switchGameTab('accusation-tab');
        }
        
        // Format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        // Update button states based on game state
        function updateButtonStates() {
            if (gameState.gameWon.won) {
                // Disable check suggestion button
                document.getElementById('check-suggestion-btn').disabled = true;
                
                // Disable accusation button
                document.getElementById('scan-accusation-btn').disabled = true;
                
                // Scan card button stays enabled
            }
        }
    </script>
</body>
</html>
